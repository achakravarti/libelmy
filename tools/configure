#!/bin/sh

. "$(dirname "0")/../external/shflags/shflags"
. "$(dirname "0")/../tools/os.sh"
. "$(dirname "0")/../tools/pkg.sh"
. "$(dirname "0")/../tools/msg.sh"


# -b,--bin (default true)
# -c,--check (default true)
# -d,--database (default true)
# -f,--force (default false)
# -m,--man (default true)
# -r,--release (default false)
# -u,--update (default true)


export OS


# MAIN FUNCTIONS


main_setup()
{
        DEFINE_boolean 'man' true 'generate man pages' 'm'
        DEFINE_boolean 'upgrade' false 'upgrade package manager' 'u'
        DEFINE_boolean 'check' true 'support check tools' 'c'
        DEFINE_boolean 'database' true 'generate database' 'd'
        DEFINE_boolean 'release' false 'build for release' 'r'
        DEFINE_boolean 'force' false 'force regeneration' 'f'

        FLAGS "$@" || exit $?
        eval set -- "$FLAGS_ARGV"

        os_query
}


main_exec()
{
        case "$OS_DISTRO" in
        Alpine)
                ./configure-alpine.sh "$@"
                ;;

        Arch)
                ./configure-arch.sh "$@"
                ;;

        FreeBSD)
                pkg_freebsd
                ;;

        *)
                pkg_debian
                ;;
        esac
}


# PACKAGE INSTALLATION FUNCTIONS


pkg_debian()
{
        msg_fail "not implemented"

        pkg_install gcc
        pkg_install make
        pkg_install postgresql
        pkg_install postgresql-contrib
        pkg_install libpq-dev
        pkg_install rsyslog

        if [ "$FLAGS_man" -eq "$FLAGS_TRUE" ]; then
                pkg_install pandoc
                pkg_install pandoc-citeproc
                pkg_install groff
        else
                msg_warn "--noman set, skipping support for man pages"
        fi

        if [ "$FLAGS_check" -eq "$FLAGS_TRUE" ]; then
                pkg_install valgrind
                pkg_install libcriterion-dev
        else
                msg_warn "--nocheck set, skipping support for check tools"
        fi
}


pkg_freebsd()
{
        pkg_install llvm13
        pkg_install postgresql14-server
        pkg_install postgresql14-contrib
        pkg_install postgresql-libpgeasy
        pkg_install rsyslog

        if [ "$FLAGS_man" -eq "$FLAGS_TRUE" ]; then
                pkg_install hs-pandoc
                pkg_install hs-pandoc-crossref
        else
                msg_warn "--noman set, skipping support for man pages"
        fi

        if [ "$FLAGS_check" -eq "$FLAGS_TRUE" ]; then
                pkg_install valgrind
                pkg_install criterion
        else
                msg_warn "--nocheck set, skipping support for check tools"
        fi
}


# MAIN ENTRY POINT


main_setup "$@"
main_exec "$@"
